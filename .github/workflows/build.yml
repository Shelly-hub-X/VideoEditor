name: Build and Package Video Editor

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        git checkout 365f6444ab40ee87c73c947b475b3a267b3cb77c
        .\bootstrap-vcpkg.bat -disableMetrics
        echo "VCPKG_ROOT=${{ github.workspace }}\vcpkg" >> $env:GITHUB_ENV

    - name: Cache vcpkg packages
      uses: actions/cache@v3
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
          vcpkg/buildtrees
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Install Dependencies
      run: |
        cd vcpkg
        .\vcpkg install --triplet=x64-windows

    - name: Configure CMake
      run: |
        cmake -B build -S . `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake"

    - name: Build Project
      run: |
        cmake --build build --config Release --parallel 2

    - name: Package Application
      run: |
        # Create release directory
        New-Item -ItemType Directory -Force -Path release/VideoEditor

        # Copy executable
        Copy-Item build/Release/VideoEditor.exe release/VideoEditor/ -ErrorAction Stop

        # Debug: Show vcpkg directory structure
        Write-Host "Checking vcpkg directory structure..."
        if (Test-Path "vcpkg/installed/x64-windows") {
          Write-Host "✅ Found vcpkg/installed/x64-windows"
          Get-ChildItem "vcpkg/installed/x64-windows" | Select-Object Name
        }

        # Find and run windeployqt
        $windeployqt = Get-ChildItem -Path "vcpkg/installed/x64-windows" -Filter windeployqt.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($windeployqt) {
          Write-Host "✅ Found windeployqt: $($windeployqt.FullName)"
          & $windeployqt.FullName release/VideoEditor/VideoEditor.exe --release --no-translations --no-system-d3d-compiler
        } else {
          Write-Warning "⚠️  windeployqt not found, copying DLLs manually..."
          if (Test-Path "vcpkg/installed/x64-windows/bin") {
            Copy-Item "vcpkg/installed/x64-windows/bin/*.dll" release/VideoEditor/ -ErrorAction SilentlyContinue
            Write-Host "✅ Copied DLLs from vcpkg/installed/x64-windows/bin"
          }
        }        # Copy documentation
        if (Test-Path README.md) { Copy-Item README.md release/VideoEditor/ }
        if (Test-Path LICENSE) { Copy-Item LICENSE release/VideoEditor/ }
        
        # Create archive
        Compress-Archive -Path release/VideoEditor -DestinationPath VideoEditor-Windows-x64.zip -Force
        
        Write-Host "Package created successfully!"
        Get-ChildItem release/VideoEditor | Format-Table Name, Length

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: VideoEditor-Windows-x64
        path: VideoEditor-Windows-x64.zip
        if-no-files-found: error
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: VideoEditor-Windows-x64.zip
        draft: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

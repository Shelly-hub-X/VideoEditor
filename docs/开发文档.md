# 开发文档

## 目录
- [项目架构](#项目架构)
- [核心类说明](#核心类说明)
- [开发环境配置](#开发环境配置)
- [编译与调试](#编译与调试)
- [FFmpeg集成](#ffmpeg集成)
- [性能优化](#性能优化)

---

## 项目架构

### 整体架构

本项目采用**多线程MVC架构**:

```
┌─────────────────────────────────────────┐
│           UI Layer (Qt Widgets)         │
│  ┌─────────────────────────────────┐   │
│  │       MainWindow (View)         │   │
│  └─────────────────────────────────┘   │
└──────────────┬──────────────────────────┘
               │ 信号/槽
┌──────────────▼──────────────────────────┐
│      Application Layer (Controllers)    │
│  ┌──────────────┐  ┌─────────────────┐ │
│  │ VideoPlayer  │  │ VideoProcessor  │ │
│  └──────────────┘  └─────────────────┘ │
└──────────────┬──────────────────────────┘
               │ 工作线程
┌──────────────▼──────────────────────────┐
│       Core Layer (FFmpeg Wrapper)       │
│  ┌──────────────┐  ┌─────────────────┐ │
│  │ VideoDecoder │  │ VideoEncoder    │ │
│  └──────────────┘  └─────────────────┘ │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         FFmpeg Libraries                │
│  libavformat | libavcodec | libswscale  │
└─────────────────────────────────────────┘
```

### 线程模型

- **主线程 (UI Thread)**: 
  - 处理所有UI事件和渲染
  - 通过Qt信号/槽与工作线程通信
  
- **解码线程 (Decode Thread)**:
  - 在`VideoPlayer`中运行
  - 解码视频帧并发送到主线程显示
  
- **处理线程 (Processing Thread)**:
  - 在`VideoProcessor`中运行
  - 执行视频拆分和合成任务

---

## 核心类说明

### MainWindow
主窗口类，负责UI布局和用户交互。

**主要职责**:
- 创建和管理所有UI组件
- 响应用户操作 (按钮点击、进度条拖动等)
- 接收并显示来自后台线程的数据

**关键方法**:
```cpp
void onOpenFile();      // 打开视频文件
void onPlayPause();     // 播放/暂停切换
void onSplitVideo();    // 拆分视频
void onMergeVideo();    // 合成视频
void onFrameReady();    // 显示新帧
```

### VideoPlayer
视频播放器类，负责视频解码和播放控制。

**主要职责**:
- 打开和解析视频文件
- 在后台线程中解码视频
- 控制播放状态 (播放/暂停/跳转)
- 通过信号发送解码后的帧

**关键方法**:
```cpp
bool openFile(const QString &filePath);
void play();
void pause();
void seek(qint64 milliseconds);
```

**线程安全**:
- 使用`QMutex`保护共享资源
- 使用`std::atomic`标志控制线程状态

### VideoDecoder
视频解码器类，用于视频拆分功能。

**主要职责**:
- 顺序解码视频的所有帧
- 将AVFrame转换为QImage
- 提供视频元信息

**使用示例**:
```cpp
VideoDecoder decoder;
decoder.open("video.mp4");

QImage frame;
while (decoder.decodeNextFrame(frame)) {
    frame.save(QString("frame_%1.jpg").arg(count++));
}
```

### VideoEncoder
视频编码器类，用于视频合成功能。

**主要职责**:
- 初始化视频编码器 (支持硬件加速)
- 将QImage编码为视频帧
- 写入MP4容器

**硬件加速**:
- NVIDIA: h264_nvenc
- Intel: h264_qsv
- AMD: h264_amf
- 软件: libx264

**使用示例**:
```cpp
VideoEncoder encoder;
encoder.open("output.mp4", 1920, 1080, 25.0);

for (const QImage &frame : frames) {
    encoder.encodeFrame(frame);
}

encoder.finalize();
```

### VideoProcessor
视频处理器类，在后台线程中执行耗时操作。

**主要职责**:
- 拆分视频为图片序列 + 音频
- 合成图片序列 + 音频为视频
- 发送进度更新信号

---

## 开发环境配置

### 必需工具

1. **C++ 编译器**
   - Windows: MSVC 2019/2022 (Visual Studio)
   - 推荐: Visual Studio 2022 Community Edition

2. **CMake** (>= 3.20)
   ```powershell
   winget install Kitware.CMake
   ```

3. **Qt 6** (>= 6.2)
   ```powershell
   # 下载 Qt Online Installer
   # https://www.qt.io/download-qt-installer
   ```

4. **vcpkg** (包管理器)
   ```powershell
   git clone https://github.com/Microsoft/vcpkg.git
   cd vcpkg
   .\bootstrap-vcpkg.bat
   .\vcpkg integrate install
   ```

### 安装依赖

```powershell
# 进入vcpkg目录
cd vcpkg

# 安装FFmpeg和Qt
.\vcpkg install ffmpeg:x64-windows
.\vcpkg install qt6-base:x64-windows
.\vcpkg install qt6-multimedia:x64-windows
```

### VS Code 扩展

推荐安装以下扩展:
- C/C++ (Microsoft)
- CMake Tools (Microsoft)
- Qt Configure (Lever Studio)

---

## 编译与调试

### 方法一: 使用PowerShell脚本

```powershell
# 构建项目
.\build.ps1

# 运行程序
.\run.ps1
```

### 方法二: 使用VS Code任务

1. 打开命令面板 (`Ctrl+Shift+P`)
2. 选择 `Tasks: Run Task`
3. 选择 `完整构建并运行`

### 方法三: 手动CMake命令

```powershell
# 配置
cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=[vcpkg路径]/scripts/buildsystems/vcpkg.cmake

# 编译
cmake --build build --config Release

# 运行
.\build\bin\Release\VideoEditor.exe
```

### 调试技巧

1. **启用详细日志**:
```cpp
// 在main.cpp中添加
qSetMessagePattern("%{time yyyy-MM-dd hh:mm:ss} [%{type}] %{message}");
```

2. **FFmpeg日志**:
```cpp
// 设置FFmpeg日志级别
av_log_set_level(AV_LOG_DEBUG);
```

3. **性能分析**:
```cpp
// 使用Qt的性能计时器
QElapsedTimer timer;
timer.start();
// ... 操作 ...
qDebug() << "耗时:" << timer.elapsed() << "ms";
```

---

## FFmpeg集成

### 初始化

在使用FFmpeg之前无需显式初始化，新版本FFmpeg会自动注册编解码器。

### 错误处理

```cpp
char errbuf[128];
av_strerror(ret, errbuf, sizeof(errbuf));
qDebug() << "FFmpeg错误:" << errbuf;
```

### 内存管理

FFmpeg使用引用计数管理内存:

```cpp
// 分配
AVPacket *packet = av_packet_alloc();
AVFrame *frame = av_frame_alloc();

// 使用后释放引用
av_packet_unref(packet);
av_frame_unref(frame);

// 最终释放
av_packet_free(&packet);
av_frame_free(&frame);
```

### 硬件加速检测

```cpp
// 检查可用的硬件加速器
AVCodec *codec = avcodec_find_decoder(AV_CODEC_ID_H264);
for (int i = 0;; i++) {
    const AVCodecHWConfig *config = avcodec_get_hw_config(codec, i);
    if (!config) break;
    qDebug() << "支持硬件加速:" << av_hwdevice_get_type_name(config->device_type);
}
```

---

## 性能优化

### 1. 解码优化

- **使用硬件加速**: 优先选择NVENC/QSV/AMF解码器
- **多线程解码**: 设置`m_codecContext->thread_count`
- **跳过B帧**: 使用`AVDISCARD_NONREF`

### 2. 编码优化

- **预设选择**: `ultrafast` (最快) 到 `veryslow` (最高质量)
- **零延迟**: `tune=zerolatency` 适合实时应用
- **码率控制**: CBR (恒定码率) vs VBR (可变码率)

### 3. UI优化

- **避免频繁更新**: 限制帧率到30fps
- **使用双缓冲**: 避免画面闪烁
- **异步IO**: 所有文件操作在工作线程中进行

### 4. 内存优化

- **复用缓冲区**: 避免频繁分配/释放
- **使用智能指针**: 自动管理资源生命周期
- **及时释放**: 不再使用的资源立即释放

---

## 常见问题

### Q1: 找不到FFmpeg库
**A**: 确保vcpkg已正确安装FFmpeg，并在CMake中指定了工具链文件。

### Q2: 视频播放卡顿
**A**: 
1. 检查解码线程是否正常运行
2. 减小帧率或分辨率
3. 启用硬件加速

### Q3: 编译错误: 找不到Qt头文件
**A**: 
1. 确保Qt已添加到PATH
2. 在CMake中正确配置Qt路径
3. 检查`CMAKE_PREFIX_PATH`

### Q4: 运行时找不到DLL
**A**:
1. 使用`windeployqt`复制Qt DLL
2. 将FFmpeg DLL复制到exe目录
3. 或将相关目录添加到PATH

---

## 扩展开发

### 添加新的视频格式支持

1. 在`VideoDecoder`中添加格式检测
2. 注册对应的解码器
3. 更新文件过滤器

### 添加视频特效

1. 在`VideoProcessor`中创建新方法
2. 使用FFmpeg的`libavfilter`库
3. 在UI中添加对应的控制按钮

### 批量处理

1. 创建`BatchProcessor`类
2. 使用队列管理待处理文件
3. 显示整体进度

---

## 贡献指南

欢迎提交Pull Request！请确保:
- 代码符合现有风格
- 添加必要的注释
- 更新相关文档
- 通过所有测试

---

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。
